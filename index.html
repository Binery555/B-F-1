<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deriv Under-Only Auto Trading Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(145deg, #2c003e, #0a1f2d); color: #f0f0f0; }
    #alarmDisplay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%;
      background: #ff3333;
      color: #fff;
      text-align: center;
      padding: 10px;
      font-size: 16px;
      z-index: 1000;
      animation: flash 1s infinite;
    }
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    #deriv-login { display: flex; justify-content: center; align-items: center; height: 100vh; background: rgba(255,255,255,0.02); }
    #deriv-login button { padding: 14px 28px; background: #00c3ff; color: #fff; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; box-shadow: 0 0 12px #00c3ff, 0 0 24px #00c3ff; }
    #deriv-tool { display: none; padding: 30px; }
    h1 { text-align: center; font-size: 30px; margin-bottom: 30px; color: #84ffb4; text-shadow: 0 0 6px #0ff; }
    .container { display: flex; flex-wrap: wrap; gap: 25px; }
    .left-panel, .right-panel { flex: 1; min-width: 300px; }
    .box { background: rgba(255,255,255,0.06); backdrop-filter: blur(12px); border-radius: 14px; padding: 20px; margin-bottom: 25px; box-shadow: 0 0 14px rgba(0,255,255,0.15); }
    #liveQuote { font-size: 26px; margin-bottom: 14px; color: #00ffe0; text-align: center; }
    #ldpIndicator { font-size: 72px; font-weight: bold; text-align: center; padding: 20px; background: #111; border-radius: 16px; margin: auto; transition: transform 0.3s ease; box-shadow: inset 0 0 20px #3ef2ff; }
    label { font-size: 14px; margin-top: 10px; display: block; }
    input, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 8px; border: none; background: #292929; color: #fff; }
    button { padding: 12px; margin-top: 14px; border-radius: 10px; border: none; font-size: 16px; cursor: pointer; font-weight: bold; width: 100%; }
    #underBtn { background: #ff9757; color: #000; box-shadow: 0 0 14px #ff9757; }
    #resumeBtn { background: #aaff77; color: #000; display: none; }
    #signalStrength { font-size: 18px; margin-top: 16px; color: #ffee00; font-weight: 600; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 8px; border-bottom: 1px solid #444; text-align: center; }
    .win { background: #083f0c; color: #0f0; }
    .loss { background: #470000; color: #f66; }
    #pauseStatus { font-size: 15px; color: #ffcc00; text-align: center; margin-top: 10px; }
    .switch-box { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 12px; }
    @keyframes scrollUp { 0% { transform: translateY(100%); } 100% { transform: translateY(-100%); } }
    #volStats { animation: scrollUp 25s linear infinite; }
    #volStats div { font-size: 13px; padding: 4px; border-bottom: 1px dashed #444; }

    /* Market Signal Monitor UI */
    .markets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .market-box {
      background: rgba(0,0,0,0.45);
      border-radius: 10px;
      padding: 8px 6px;
      text-align: center;
      border: 1px solid #555;
      font-size: 13px;
      transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }
    .market-box .symbol {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .market-box .last-digit {
      font-size: 20px;
      margin-top: 4px;
    }
    .market-box .signal-flag {
      margin-top: 4px;
      font-size: 11px;
    }
    .market-box.has-signal {
      background: #5a0000;
      border-color: #ff4444;
      box-shadow: 0 0 15px rgba(255,68,68,0.85);
      transform: translateY(-2px);
    }
    .signal-row {
      background: #331111;
      color: #ffdddd;
    }
  </style>
</head>
<body>
  <div id="alarmDisplay"></div>
  <div id="deriv-login">
    <button id="loginBtn">Login with Deriv</button>
  </div>
  <div id="deriv-tool">
    <h1>üìä Under-Only Auto Trading Tool</h1>
    <div class="container">
      <div class="left-panel">
        <div class="box">
          <div id="liveQuote">Quote: -</div>
          <div id="ldpIndicator">0</div>
          <div id="signalStrength">Waiting for Signal...</div>
          <canvas id="percentChart" width="400" height="180" style="margin-top:20px;"></canvas>
          <div id="pauseStatus"></div>
          <button id="resumeBtn">üü¢ Resume Now</button>
        </div>
        <div class="box">
          <h3>Signal + Trade History</h3>
          <table>
            <thead><tr><th>Time</th><th>Signal</th><th>Stake</th><th>Status</th></tr></thead>
            <tbody id="tradeHistory"></tbody>
          </table>
        </div>
      </div>
      <div class="right-panel">
        <label for="marketSelect">Market:</label>
        <select id="marketSelect"></select>
        <label for="duration">Duration (ticks):</label>
        <select id="duration"></select>
        <label for="stake">Stake:</label>
        <input type="number" id="stake" step="0.01" value="0.65" />
        <label for="barrier">Barrier (0‚Äì9):</label>
        <input type="number" id="barrier" min="0" max="9" value="7" />
        <button id="underBtn">Under</button>
        <div class="switch-box">
          <label>Auto Trade:</label><input type="checkbox" id="autoToggle" />
        </div>
        <div style="margin-top:10px;">
          ID: <span id="loginId">-</span><br>
          Balance: <span id="balance">-</span> USD&nbsp;&nbsp;Profit: <span id="profit">0.00</span> USD
        </div>
        <div class="box" style="max-height:180px;overflow:hidden;position:relative;">
          <h3>üìà Volatility Market Stats</h3>
          <div id="volStats"></div>
        </div>
        <div class="box">
          <h3>üì° Market Signal Monitor</h3>
          <div id="marketsGrid" class="markets-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- main signal sound -->
  <audio id="voiceUnder" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto" autoplay></audio>
  <!-- market change sound -->
  <audio id="marketChangeSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const APP_ID = '82610';
    const REDIRECT_URI = location.origin + location.pathname;
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    const tokenParam = new URLSearchParams(location.search).get('token1');
    const acctParam  = new URLSearchParams(location.search).get('acct1');

    if (tokenParam && acctParam) {
      localStorage.setItem('deriv_token', tokenParam);
      localStorage.setItem('deriv_loginid', acctParam);
      location.href = REDIRECT_URI;
    }

    const TOKEN = localStorage.getItem('deriv_token');
    let initialBalance = 0, currentBalance = 0;

    if (!TOKEN) {
      document.getElementById('loginBtn').onclick = () => window.location = OAUTH_URL;
    } else {
      document.getElementById('deriv-login').style.display = 'none';
      document.getElementById('deriv-tool').style.display = 'block';
      initTool();
    }

    function initTool() {
      // Markets: R10, R25, R75, R100 (R50 removed)
      const markets = ['R_10','R_25','R_75','R_100'];
      const marketSelect = document.getElementById('marketSelect');
      markets.forEach(m => marketSelect.add(new Option(m, m)));

      for (let i = 1; i <= 10; i++) {
        document.getElementById('duration').add(new Option(`${i} ticks`, `${i}t`));
      }

      const volStatsData = {};
      const marketsGrid = document.getElementById('marketsGrid');
      const marketStates = {};

      // market boxes + state (for all markets view)
      markets.forEach(symbol => {
        marketStates[symbol] = {
          consecutiveInRange: 0, // digits 0‚Äì5 in a row
          hasSignal: false,
          lastDigit: null
        };
        if (marketsGrid) {
          const box = document.createElement('div');
          box.className = 'market-box';
          box.dataset.symbol = symbol;
          box.innerHTML = `
            <div class="symbol">${symbol}</div>
            <div class="last-digit">-</div>
            <div class="signal-flag"></div>
          `;
          marketsGrid.appendChild(box);
        }
      });

      // decimal format + last digit (after decimal) handling
      function formatPriceAndDigit(symbolFull, quote) {
        const base = symbolFull.replace('_1s', '');
        const rawStr = quote.toFixed(5); // raw 5 decimals
        const parts = rawStr.split('.');
        const intPart = parts[0];
        const decPart = parts[1] || '';
        let wanted;
        if (base === 'R_75') {
          wanted = 4;   // R75 -> decimal +1 digit
        } else if (base === 'R_100') {
          wanted = 2;   // R100 -> decimal -1 digit
        } else {
          wanted = 3;   // default -> 3 decimals (remove 2)
        }
        const trimmed = decPart.slice(0, wanted);
        const display = trimmed ? `${intPart}.${trimmed}` : intPart;
        const lastDigit = trimmed ? parseInt(trimmed[trimmed.length - 1], 10) : null;
        return { display, lastDigit };
      }

      function renderVolStats() {
        const html = Object.entries(volStatsData)
          .map(([s, q]) => {
            const { display } = formatPriceAndDigit(s, q);
            return `<div>${s}: ${display}</div>`;
          })
          .join('');
        document.getElementById('volStats').innerHTML = html;
      }

      const ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`);
      let digitCounts = Array(10).fill(0);
      let activeTrade = false;

      const percentChart = new Chart(
        document.getElementById('percentChart').getContext('2d'),
        {
          type: 'doughnut',
          data: {
            labels: [...Array(10).keys()].map(n => `Digit ${n}`),
            datasets: [{ data: digitCounts, borderWidth: 1 }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff' } }
            }
          }
        }
      );

      const martingalePlan = [
        { stake: 0.65, digit: 7 },
        { stake: 1.03, digit: 6 },
        { stake: 2.65, digit: 6 },
        { stake: 4.54, digit: 5 },
        { stake: 6.95, digit: 5 },
        { stake: 9.21, digit: 5 },
        { stake: 11.55, digit: 5 },
        { stake: 13.75, digit: 5 },
        { stake: 14.55, digit: 5 },
        { stake: 15.35, digit: 5 }
      ];

      let currentStep = 0,
          consecutiveLosses = 0,
          consecutiveWins = 0,
          pauseUntil = null,
          thresholdPauseUntil = null,
          profitReached = false,
          lossReached = false;

      function shouldPause() {
        const now = Date.now();
        return (pauseUntil && now < pauseUntil) || (thresholdPauseUntil && now < thresholdPauseUntil);
      }

      function setPause(mins) {
        pauseUntil = Date.now() + mins * 60000;
        document.getElementById('resumeBtn').style.display = 'inline-block';
      }

      function hold24h() {
        thresholdPauseUntil = Date.now() + 24 * 60 * 60000;
        document.getElementById('underBtn').disabled = true;
        document.getElementById('alarmDisplay').style.display = 'block';
      }

      function showPauseCountdown() {
        const el = document.getElementById('pauseStatus');
        const now = Date.now();

        if (thresholdPauseUntil) {
          const left = thresholdPauseUntil - now;
          if (left > 0) {
            const h = Math.floor(left / 3600000);
            const m = Math.floor((left % 3600000) / 60000);
            const s = Math.floor((left % 60000) / 1000);
            el.textContent = `‚è∏ Hold until ${h}h ${m}m ${s}s`;
            return;
          } else {
            thresholdPauseUntil = null;
            document.getElementById('underBtn').disabled = false;
            document.getElementById('alarmDisplay').style.display = 'none';
            el.textContent = '‚úÖ Resumed after 24h';
            setTimeout(() => (el.textContent = ''), 3000);
            initialBalance = currentBalance;
            profitReached = false;
            lossReached = false;
          }
        }

        if (pauseUntil) {
          const left2 = pauseUntil - now;
          if (left2 > 0) {
            const mins = Math.floor(left2 / 60000);
            const secs = Math.floor((left2 % 60000) / 1000);
            el.textContent = `‚è∏ Paused (${mins}m ${secs}s)`;
          } else {
            pauseUntil = null;
            el.textContent = '‚úÖ Auto resumed.';
            setTimeout(() => (el.textContent = ''), 3000);
          }
        }
      }

      setInterval(showPauseCountdown, 1000);

      document.getElementById('resumeBtn').onclick = () => {
        pauseUntil = null;
        document.getElementById('resumeBtn').style.display = 'none';
        const el = document.getElementById('pauseStatus');
        el.textContent = '‚úÖ Manually resumed.';
        setTimeout(() => (el.textContent = ''), 3000);
      };

      function updateMartingale(win) {
        if (win) {
          currentStep = 0;
          consecutiveLosses = 0;
          consecutiveWins++;
          if (consecutiveWins >= 2) {
            setPause(5);
            consecutiveWins = 0;
          }
        } else {
          consecutiveWins = 0;
          consecutiveLosses++;
          currentStep = Math.min(currentStep + 1, martingalePlan.length - 1);
          const pm = { 2: 2, 3: 5, 4: 10, 5: 20, 6: 30, 7: 40, 8: 60 };
          if (pm[consecutiveLosses]) setPause(pm[consecutiveLosses]);
          const mEl = document.getElementById('marketSelect');
          mEl.selectedIndex = (mEl.selectedIndex + 1) % mEl.options.length;
        }
        const plan = martingalePlan[currentStep];
        document.getElementById('stake').value = plan.stake;
        document.getElementById('barrier').value = plan.digit;
      }

      function placeTrade(type) {
        if (activeTrade || shouldPause()) return;
        const stake = +document.getElementById('stake').value;
        const dur = +document.getElementById('duration').value.replace('t', '');
        const barrier = document.getElementById('barrier').value;
        ws.send(JSON.stringify({
          buy: 1,
          price: stake,
          parameters: {
            amount: stake,
            basis: 'stake',
            contract_type: type,
            currency: 'USD',
            duration: dur,
            duration_unit: 't',
            symbol: document.getElementById('marketSelect').value,
            barrier
          }
        }));
        activeTrade = true;
      }

      function triggerSignal(symbol, count, lastDigit) {
        const time = new Date().toLocaleTimeString();
        const message = `Signal (${symbol}) - last digit 0‚Äì5 for ${count} ticks (last: ${lastDigit})`;
        document.getElementById('signalStrength').textContent = message;

        // signal history row (‡∂±‡∑ú‡∂∏‡∑ê‡∂ö‡∑ô‡∂± history)
        const row = document.createElement('tr');
        row.className = 'signal-row';
        row.innerHTML = `<td>${time}</td><td>${message}</td><td>-</td><td>SIGNAL</td>`;
        document.getElementById('tradeHistory').prepend(row);

        // signal sound
        const audio = document.getElementById('voiceUnder');
        if (audio) audio.play();

        // signal ‡∂á‡∂≠‡∑í market box ‡∂ë‡∂ö ‡∂ª‡∂≠‡∑î ‡∑Ä‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä highlight
        const box = document.querySelector(`.market-box[data-symbol="${symbol}"]`);
        if (box) {
          box.classList.add('has-signal');
          const flag = box.querySelector('.signal-flag');
          if (flag) flag.textContent = 'SIGNAL';
        }

        // üÜï Signal ‡∂Ω‡∑ê‡∂∂‡∑î‡∂´‡∑î market ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂ã‡∂© ‡∂≠‡∑í‡∂∫‡∑ô‡∂± selected market ‡∂ë‡∂ö change ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        const select = document.getElementById('marketSelect');
        if (select) {
          for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === symbol) {
              select.selectedIndex = i;
              break;
            }
          }
        }

        // ‚úÖ Auto icon ‡∂ß tick ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è‡∂±‡∂∏‡∑ä, signal ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä DIGITUNDER trade ‡∂ë‡∂ö auto open ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
        if (
          document.getElementById('autoToggle').checked &&
          document.getElementById('marketSelect').value === symbol &&
          !shouldPause() &&
          !activeTrade
        ) {
          placeTrade('DIGITUNDER');
        }
      }

      ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: TOKEN }));
      };

      ws.onmessage = ({ data }) => {
        const msg = JSON.parse(data);

        if (msg.authorize) {
          document.getElementById('loginId').innerText = msg.authorize.loginid;
          initialBalance = +msg.authorize.balance;
          currentBalance = initialBalance;
          document.getElementById('balance').innerText = currentBalance.toFixed(2);
          document.getElementById('profit').innerText = '0.00';

          // subscribe (no R_50 / R_50_1s)
          ['R_10','R_25','R_75','R_100','R_10_1s','R_25_1s','R_75_1s','R_100_1s']
            .forEach(s => ws.send(JSON.stringify({ ticks: s, subscribe: 1 })));

          ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
          return;
        }

        if (msg.balance) {
          currentBalance = +msg.balance.balance;
          document.getElementById('balance').innerText = currentBalance.toFixed(2);
          const profit = currentBalance - initialBalance;
          document.getElementById('profit').innerText = profit.toFixed(2);

          if (!profitReached && profit / initialBalance >= 0.05) {
            profitReached = true;
            document.getElementById('alarmDisplay').textContent = 'You have earned 5% for today.';
            hold24h();
            document.getElementById('voiceUnder').play();
          }
          if (!lossReached && profit / initialBalance <= -0.25) {
            lossReached = true;
            document.getElementById('alarmDisplay').textContent = "Don't trade today.";
            hold24h();
            document.getElementById('voiceUnder').play();
          }
          return;
        }

        if (msg.tick) {
          const symbolFull = msg.tick.symbol;   // e.g. R_10, R_10_1s
          const base = symbolFull.replace('_1s','');

          volStatsData[symbolFull] = msg.tick.quote;
          renderVolStats();

          const { display, lastDigit } = formatPriceAndDigit(symbolFull, msg.tick.quote);

          // per-market signal tracking (0‚Äì5 last digit, 7 ‡∑Ä‡∂ª‡∂ö‡∑ä in a row)
          if (marketStates[base]) {
            const st = marketStates[base];
            st.lastDigit = lastDigit;

            const box = document.querySelector(`.market-box[data-symbol="${base}"]`);
            if (box) {
              const ld = box.querySelector('.last-digit');
              if (ld) ld.textContent = lastDigit !== null ? lastDigit : '-';
            }

            if (lastDigit !== null && lastDigit >= 0 && lastDigit <= 5) {
              st.consecutiveInRange = (st.consecutiveInRange || 0) + 1;
            } else {
              st.consecutiveInRange = 0;
              st.hasSignal = false;
              if (box) {
                box.classList.remove('has-signal');
                const flag = box.querySelector('.signal-flag');
                if (flag) flag.textContent = '';
              }
            }

            if (st.consecutiveInRange >= 7 && !st.hasSignal) {
              st.hasSignal = true;
              triggerSignal(base, st.consecutiveInRange, lastDigit);
            }
          }

          // main live quote + chart for selected market
          if (symbolFull === document.getElementById('marketSelect').value) {
            document.getElementById('liveQuote').textContent = `Quote: ${display}`;
            if (lastDigit !== null) {
              digitCounts[lastDigit] = (digitCounts[lastDigit] || 0) + 1;
              percentChart.data.datasets[0].data = digitCounts;
              percentChart.update();
              document.getElementById('ldpIndicator').textContent = lastDigit;
            }
          }

          return;
        }

        if (msg.buy) {
          const cid = msg.buy.contract_id;
          const t = new Date().toLocaleTimeString();
          const row = document.createElement('tr');
          row.id = `row-${cid}`;
          row.innerHTML = `<td>${t}</td><td>${msg.echo_req.parameters.contract_type}</td><td>${msg.echo_req.price}</td><td id="status-${cid}">OPEN</td>`;
          document.getElementById('tradeHistory').prepend(row);
          ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: cid, subscribe: 1 }));
          return;
        }

        if (msg.proposal_open_contract) {
          const c = msg.proposal_open_contract;
          const row = document.getElementById(`row-${c.contract_id}`);
          const st = document.getElementById(`status-${c.contract_id}`);
          if (!row || !st) return;
          if (c.status === 'won') {
            row.className = 'win';
            st.textContent = 'WON';
            activeTrade = false;
            updateMartingale(true);
          } else if (c.status === 'lost') {
            row.className = 'loss';
            st.textContent = 'LOST';
            activeTrade = false;
            updateMartingale(false);
          }
          return;
        }
      };

      document.getElementById('underBtn').onclick = () => placeTrade('DIGITUNDER');

      // Market auto change every 5 minutes + different sound
      setInterval(() => {
        const select = document.getElementById('marketSelect');
        if (!select || !select.options.length) return;
        select.selectedIndex = (select.selectedIndex + 1) % select.options.length;
        const psEl = document.getElementById('pauseStatus');
        const txt = `üîÑ Market auto-switched to ${select.value}`;
        psEl.textContent = txt;
        setTimeout(() => { if (psEl.textContent === txt) psEl.textContent = ''; }, 4000);
        const marketSound = document.getElementById('marketChangeSound');
        if (marketSound) marketSound.play();
      }, 5 * 60 * 1000);
    }
  </script>
</body>
</html>
